<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <!-- Viewport WAJIB untuk responsive design -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Visualisasi Data E-Commerce</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Chart.js (teknologi utama Anda) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Menggunakan font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Mengaplikasikan font Inter ke seluruh halaman */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* bg-slate-900 */
        }
        /* Transisi smooth untuk semua elemen */
        * {
            transition: all 0.15s ease-in-out;
        }
        
        /* --- PERBAIKAN BUG RESPONSIVITAS --- */
        /* Memberi ukuran pada canvas wrapper agar tidak kolaps */
        /* Rasio aspek 4:3 (umum untuk bar/line chart) */
        .chart-container {
            position: relative;
            width: 100%;
            padding-top: 75%; /* (3 / 4) * 100% = 75%. Disesuaikan dari 65% */
        }
        
        /* Rasio aspek 1:1 (ideal untuk pie/doughnut) */
        .chart-container-square {
            position: relative;
            width: 100%;
            padding-top: 100%; /* 1:1. Disesuaikan dari 90% */
        }

        /* Membuat canvas mengisi wrapper-nya */
        .chart-container canvas,
        .chart-container-square canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
        }
    </style>
</head>
<body class="bg-slate-900 text-gray-200 min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header Utama dan Nama Kelompok -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">
                Dashboard Visualisasi Data E-Commerce
            </h1>
            <p class="text-lg text-gray-400 mb-3">
                Analisis interaktif dari data transaksi e-commerce.
            </p>
            <p class="text-sm text-gray-500">
                Dikerjakan oleh: Andrian, Joice Omasi Angelita Harefa, dan Fauzan Al Gholi
            </p>
        </header>

        <!-- Panel Kontrol: Upload File -->
        <div class="bg-slate-800 p-6 rounded-lg shadow-xl mb-8 max-w-2xl mx-auto">
            <h2 class="text-xl font-semibold mb-4 text-white text-center">Mulai Analisis</h2>
            <p class="text-gray-400 mb-5 text-center text-sm">
                Unggah file `ecommerce_transactions.csv` Anda untuk memuat dashboard.
            </p>
            
            <!-- Input file yang lebih modern -->
            <label for="csvFileInput" class="w-full flex justify-center px-4 py-6 bg-slate-700 rounded-lg border-2 border-dashed border-slate-600 cursor-pointer hover:border-blue-500 hover:bg-slate-700/80">
                <div class="text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-500" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                    <span class="mt-2 block text-sm font-semibold text-blue-400" id="fileUploadText">Pilih sebuah file CSV</span>
                    <span class="block text-xs text-gray-500">Atau seret dan lepas di sini</span>
                </div>
                <input type="file" id="csvFileInput" accept=".csv" class="hidden">
            </label>

            <div id="loadingMessage" class="hidden mt-4 text-blue-400 flex items-center justify-center">
                <svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Memproses data...
            </div>
            <div id="errorMessage" class="hidden mt-4 text-red-400 font-medium text-center"></div>
        </div>

        <!-- Kontainer Statistik Utama (Lebih Menarik) -->
        <div id="statsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 hidden">
            <!-- Stat 1: Total Transaksi -->
            <div class="bg-slate-800 p-5 rounded-lg shadow-lg flex items-center space-x-4">
                <div class="flex-shrink-0 bg-blue-600 p-3 rounded-full">
                    <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H7a3 3 0 00-3 3v8a3 3 0 003 3z" />
                    </svg>
                </div>
                <div>
                    <h3 class="text-gray-400 text-sm font-medium">Total Transaksi</h3>
                    <p id="totalTransactions" class="text-2xl font-bold text-white">0</p>
                </div>
            </div>
            <!-- Stat 2: Total Pendapatan -->
            <div class="bg-slate-800 p-5 rounded-lg shadow-lg flex items-center space-x-4">
                <div class="flex-shrink-0 bg-emerald-600 p-3 rounded-full">
                     <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0c-1.657 0-3-.895-3-2s1.343-2 3-2 3-.895 3-2-1.343-2-3-2m9 4a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div>
                    <h3 class="text-gray-400 text-sm font-medium">Total Pendapatan</h3>
                    <p id="totalRevenue" class="text-2xl font-bold text-white">0</p>
                </div>
            </div>
            <!-- Stat 3: Pembelian Rata-rata -->
            <div class="bg-slate-800 p-5 rounded-lg shadow-lg flex items-center space-x-4">
                <div class="flex-shrink-0 bg-amber-600 p-3 rounded-full">
                    <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                </div>
                <div>
                    <h3 class="text-gray-400 text-sm font-medium">Pembelian Rata-rata</h3>
                    <p id="averagePurchase" class="text-2xl font-bold text-white">0</p>
                </div>
            </div>
            <!-- Stat 4: Negara Teratas -->
            <div class="bg-slate-800 p-5 rounded-lg shadow-lg flex items-center space-x-4">
                <div class="flex-shrink-0 bg-purple-600 p-3 rounded-full">
                    <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                    </svg>
                </div>
                <div>
                    <h3 class="text-gray-400 text-sm font-medium">Negara Teratas</h3>
                    <p id="topCountry" class="text-2xl font-bold text-white">-</p>
                </div>
            </div>
        </div>

        <!-- Grid untuk Chart (Responsif) -->
        <div id="chartsGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-6 hidden">
            
            <!-- Chart 1: Tren Penjualan per Bulan (Line Chart) -->
            <div class="bg-slate-800 p-4 md:p-6 rounded-lg shadow-lg">
                <!-- PERBAIKAN: Wrapper untuk rasio aspek 4:3 -->
                <div class="chart-container">
                    <canvas id="salesOverTimeChart"></canvas>
                </div>
            </div>

            <!-- Chart 2: Penjualan per Kategori Produk (Doughnut Chart) -->
            <div class="bg-slate-800 p-4 md:p-6 rounded-lg shadow-lg">
                <!-- PERBAIKAN: Wrapper untuk rasio aspek 1:1 -->
                <div class="chart-container-square">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <!-- Chart 3: Top 10 Negara (Bar Chart) -->
            <div class="bg-slate-800 p-4 md:p-6 rounded-lg shadow-lg">
                <!-- PERBAIKAN: Wrapper untuk rasio aspek 4:3 -->
                <div class="chart-container">
                    <canvas id="countryChart"></canvas>
                </div>
            </div>

            <!-- Chart 4: Distribusi Metode Pembayaran (Pie Chart) -->
            <div class="bg-slate-800 p-4 md:p-6 rounded-lg shadow-lg">
                <!-- PERBAIKAN: Wrapper untuk rasio aspek 1:1 -->
                <div class="chart-container-square">
                    <canvas id="paymentMethodChart"></canvas>
                </div>
            </div>

            <!-- Chart 5: Distribusi Usia Pelanggan (Bar Chart) -->
            <div class="bg-slate-800 p-4 md:p-6 rounded-lg shadow-lg">
                <!-- PERBAIKAN: Wrapper untuk rasio aspek 4:3 -->
                <div class="chart-container">
                    <canvas id="ageDistributionChart"></canvas>
                </div>
            </div>

            <!-- Chart 6: Distribusi Jumlah Pembelian (Histogram) -->
            <div class="bg-slate-800 p-4 md:p-6 rounded-lg shadow-lg">
                <!-- PERBAIKAN: Wrapper untuk rasio aspek 4:3 -->
                <div class="chart-container">
                    <canvas id="purchaseAmountHistogram"></canvas>
                </div>
            </div>
        </div>
        
        <!-- PENAMBAHAN: Bagian Interpretasi & Kesimpulan Dinamis -->
        <div id="interpretationSection" class="bg-slate-800 p-6 md:p-8 rounded-lg shadow-lg hidden mt-8">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Analisis & Kesimpulan Utama</h2>
            <div id="interpretationContent" class="space-y-4 text-gray-300">
                <!-- Konten akan di-generate oleh JS -->
                <p class="text-center text-gray-500">Memuat data interpretasi...</p>
            </div>
        </div>

        <!-- Footer Sederhana -->
        <footer class="mt-12 text-center text-sm text-gray-600">
            <p>Tugas Mata Kuliah Big Data &copy; 2025</p>
        </footer>
    </div>

    <script>
        // --- PERBAIKAN: Membungkus semua JS dalam DOMContentLoaded ---
        // Ini memastikan library Chart.js (di <head>) sudah dimuat
        // sebelum kita mencoba menggunakannya (misal: Chart.defaults)
        document.addEventListener('DOMContentLoaded', () => {

            // --- Konfigurasi Global Chart.js untuk Tema Gelap ---
            Chart.defaults.color = '#cbd5e1'; // text-slate-300
            Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)'; // Garis grid tipis
            Chart.defaults.plugins.title.color = '#ffffff'; // Judul chart putih
            Chart.defaults.plugins.title.font = {
                size: 18,
                weight: '600',
                family: "'Inter', sans-serif"
            };
            Chart.defaults.plugins.legend.labels.color = '#cbd5e1';

            // Variabel global
            let allTransactions = [];
            const chartInstances = {};
            // PENAMBAHAN: Variabel global untuk menyimpan data agregat
            let categorySales = {};
            let countrySales = {};
            let paymentCounts = {};
            let ageBins = {};

            // Palet warna yang cerah untuk kontras dengan tema gelap
            const appColors = [
                '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                '#14b8a6', '#f97316', '#d946ef', '#0ea5e9', '#65a30d'
            ];

            // Fungsi utilitas
            function destroyChart(chartId) {
                if (chartInstances[chartId]) {
                    chartInstances[chartId].destroy();
                    delete chartInstances[chartId];
                }
            }

            function formatCurrency(amount) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD'
                }).format(amount);
            }
            
            function formatNumber(num) {
                return new Intl.NumberFormat('id-ID').format(num);
            }

            // Fungsi parser CSV
            function parseCSV(text) {
                const lines = text.split(/\r\n|\n/);
                const headers = lines[0].split(';').map(h => h.trim());
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === "") continue;
                    const values = lines[i].split(';');
                    if (values.length === headers.length) {
                        const entry = {};
                        for (let j = 0; j < headers.length; j++) {
                            entry[headers[j]] = values[j].trim();
                        }
                        data.push(entry);
                    }
                }
                return data;
            }

            // Fungsi utama pemrosesan data
            function processData(csvText) {
                document.getElementById('loadingMessage').classList.remove('hidden');
                document.getElementById('errorMessage').classList.add('hidden');
                
                try {
                    const parsedData = parseCSV(csvText);
                    
                    allTransactions = parsedData.map(row => {
                        // Perbaikan: Ganti koma (,) dengan titik (.) untuk desimal
                        const purchaseAmount = parseFloat(row.Purchase_Amount.replace('.', '').replace(',', '.')) || 0;
                        const dateParts = row.Transaction_Date.split('/');
                        // Format tanggal: DD/MM/YYYY
                        const transactionDate = new Date(+dateParts[2], dateParts[1] - 1, +dateParts[0]);
                        return {
                            ...row,
                            Age: parseInt(row.Age) || 0,
                            Purchase_Amount_Num: purchaseAmount,
                            Transaction_Date_Obj: transactionDate,
                        };
                    }).filter(row => row.Transaction_ID && row.Transaction_Date_Obj instanceof Date && !isNaN(row.Transaction_Date_Obj)); 

                    if (allTransactions.length === 0) {
                        throw new Error("Tidak ada data valid yang ditemukan. Pastikan format CSV (delimiter ';') dan format tanggal (DD/MM/YYYY) sudah benar.");
                    }

                    // Hancurkan chart lama sebelum menggambar
                    Object.keys(chartInstances).forEach(id => destroyChart(id));
                    // Reset data agregat
                    categorySales = {};
                    countrySales = {};
                    paymentCounts = {};
                    ageBins = {};

                    displayStats();
                    
                    createSalesOverTimeChart();
                    createCategoryChart();
                    createCountryChart();
                    createPaymentMethodChart();
                    createAgeDistributionChart();
                    createPurchaseAmountHistogram();
                    
                    // PENAMBAHAN: Panggil fungsi untuk generate interpretasi
                    displayInterpretations();

                    document.getElementById('statsContainer').classList.remove('hidden');
                    document.getElementById('chartsGrid').classList.remove('hidden');
                    // PENAMBAHAN: Tampilkan bagian interpretasi
                    document.getElementById('interpretationSection').classList.remove('hidden');
                    
                } catch (error) {
                    console.error("Error processing data:", error);
                    const errorEl = document.getElementById('errorMessage');
                    errorEl.textContent = `Error: ${error.message}`;
                    errorEl.classList.remove('hidden');
                } finally {
                    document.getElementById('loadingMessage').classList.add('hidden');
                }
            }

            // Fungsi statistik
            function displayStats() {
                const totalTransactions = allTransactions.length;
                const totalRevenue = allTransactions.reduce((sum, tx) => sum + tx.Purchase_Amount_Num, 0);
                const averagePurchase = totalRevenue / totalTransactions;
                
                // Kalkulasi negara teratas dipindahkan ke sini agar datanya bisa dipakai global
                countrySales = allTransactions.reduce((acc, tx) => {
                    acc[tx.Country] = (acc[tx.Country] || 0) + tx.Purchase_Amount_Num;
                    return acc;
                }, {});
                
                // Perbaikan: Menangani kasus 'countrySales' kosong
                const topCountryEntry = Object.entries(countrySales).sort(([, a], [, b]) => b - a)[0];
                const topCountry = topCountryEntry ? topCountryEntry[0] : '-';

                document.getElementById('totalTransactions').textContent = formatNumber(totalTransactions);
                document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
                document.getElementById('averagePurchase').textContent = formatCurrency(averagePurchase);
                document.getElementById('topCountry').textContent = topCountry;
            }

            // --- PENAMBAHAN: Fungsi Interpretasi Dinamis ---
            function getTopEntry(obj) {
                // Helper untuk mendapatkan [key, value] teratas dari sebuah objek
                // Perbaikan: Menangani kasus objek kosong
                if (Object.keys(obj).length === 0) return ['-', 0];
                return Object.entries(obj).sort(([, a], [, b]) => b - a)[0];
            }

            function displayInterpretations() {
                const interpretationContent = document.getElementById('interpretationContent');
                if (!interpretationContent) return;

                try {
                    // 1. Kategori Produk
                    const [topCategory, topCategorySales] = getTopEntry(categorySales);
                    const totalRevenue = Object.values(categorySales).reduce((a, b) => a + b, 0);
                    const topCategoryPercent = totalRevenue > 0 ? ((topCategorySales / totalRevenue) * 100).toFixed(1) : 0;

                    // 2. Negara (data sudah ada di countrySales)
                    const [topCountry] = getTopEntry(countrySales);

                    // 3. Metode Pembayaran
                    const [topPayment, topPaymentCount] = getTopEntry(paymentCounts);
                    const totalTx = Object.values(paymentCounts).reduce((a, b) => a + b, 0);
                    const topPaymentPercent = totalTx > 0 ? ((topPaymentCount / totalTx) * 100).toFixed(1) : 0;

                    // 4. Demografi
                    const [topAgeGroup] = getTopEntry(ageBins);

                    // 5. Kesimpulan
                    const conclusion = `Data menunjukkan fokus bisnis yang kuat pada kategori <strong>${topCategory}</strong>, yang menyumbang ${topCategoryPercent}% pendapatan. Pasar utama adalah <strong>${topCountry}</strong>, dengan demografi inti pada kelompok usia <strong>${topAgeGroup}</strong>.`;

                    let html = `
                        <h3 class="text-xl font-semibold text-white mb-3">Interpretasi Data</h3>
                        <ul class="list-disc list-inside space-y-2 text-gray-300">
                            <li>
                                <strong>Kategori Produk Dominan:</strong> Kategori <strong>${topCategory}</strong> adalah pendorong pendapatan terbesar, menghasilkan <strong>${formatCurrency(topCategorySales)}</strong> (sekitar <strong>${topCategoryPercent}%</strong> dari total).
                            </li>
                            <li>
                                <strong>Pasar Geografis Inti:</strong> Data mengkonfirmasi bahwa <strong>${topCountry}</strong> adalah pasar terkuat, mengungguli negara-negara lain secara signifikan.
                            </li>
                            <li>
                                <strong>Demografi Pelanggan Utama:</strong> Kelompok usia <strong>${topAgeGroup}</strong> tahun adalah segmen pelanggan yang paling aktif, menunjukkan target audiens yang jelas untuk marketing.
                            </li>
                            <li>
                                <strong>Preferensi Pembayaran:</strong> Metode pembayaran yang paling sering digunakan adalah <strong>${topPayment}</strong>, mencakup <strong>${topPaymentPercent}%</strong> dari seluruh transaksi, menandakan kenyamanan pelanggan dengan metode ini.
                            </li>
                        </ul>
                        <h3 class="text-xl font-semibold text-white mt-6 mb-3">Kesimpulan & Rekomendasi</h3>
                        <p class="text-gray-400 leading-relaxed">
                            ${conclusion} Rekomendasi strategis adalah untuk (1) melakukan diversifikasi produk di luar ${topCategory} untuk mengurangi risiko ketergantungan, (2) mengoptimalkan kampanye marketing yang menargetkan kelompok usia ${topAgeGroup} di ${topCountry}, dan (3) mengevaluasi promosi untuk metode pembayaran selain ${topPayment} guna meningkatkan konversi pelanggan.
                        </p>
                    `;

                    interpretationContent.innerHTML = html;
                } catch (e) {
                    interpretationContent.innerHTML = `<p class="text-red-400">Gagal menghasilkan interpretasi: ${e.message}</p>`;
                    console.error("Error generating interpretation:", e);
                }
            }


            // --- Fungsi Pembuatan Chart ---

            // 1. Chart Tren Penjualan per Bulan (Line)
            function createSalesOverTimeChart() {
                const salesByMonth = allTransactions.reduce((acc, tx) => {
                    const monthKey = `${tx.Transaction_Date_Obj.getFullYear()}-${(tx.Transaction_Date_Obj.getMonth() + 1).toString().padStart(2, '0')}`;
                    acc[monthKey] = (acc[monthKey] || 0) + tx.Purchase_Amount_Num;
                    return acc;
                }, {});

                const sortedMonths = Object.keys(salesByMonth).sort();
                const labels = sortedMonths;
                const data = sortedMonths.map(month => salesByMonth[month]);

                const ctx = document.getElementById('salesOverTimeChart').getContext('2d');
                chartInstances['salesOverTimeChart'] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Penjualan',
                            data: data,
                            borderColor: appColors[0],
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // WAJIB false agar mengisi wrapper
                        plugins: {
                            title: { display: true, text: 'Tren Penjualan (per Bulan)' },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: { callback: (value) => formatCurrency(value) }
                            }
                        }
                    }
                });
            }

            // 2. Chart Penjualan per Kategori (Doughnut)
            function createCategoryChart() {
                // Mengisi variabel global
                categorySales = allTransactions.reduce((acc, tx) => {
                    acc[tx.Product_Category] = (acc[tx.Product_Category] || 0) + tx.Purchase_Amount_Num;
                    return acc;
                }, {});

                const labels = Object.keys(categorySales);
                const data = Object.values(categorySales);

                const ctx = document.getElementById('categoryChart').getContext('2d');
                chartInstances['categoryChart'] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Penjualan',
                            data: data,
                            backgroundColor: appColors,
                            hoverOffset: 8,
                            borderColor: '#1e293b' // bg-slate-800
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // WAJIB false agar mengisi wrapper
                        plugins: {
                            title: { display: true, text: 'Penjualan per Kategori Produk' },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(2);
                                        return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // 3. Chart Top 10 Negara (Bar)
            function createCountryChart() {
                // Data sudah dihitung di displayStats() dan disimpan di 'countrySales'
                const sortedCountries = Object.entries(countrySales).sort(([, a], [, b]) => b - a).slice(0, 10);
                const labels = sortedCountries.map(entry => entry[0]);
                const data = sortedCountries.map(entry => entry[1]);

                const ctx = document.getElementById('countryChart').getContext('2d');
                chartInstances['countryChart'] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Pendapatan',
                            data: data,
                            backgroundColor: appColors[1],
                        }]
                    },
                    options: {
                        indexAxis: 'y', // Horizontal bar chart
                        responsive: true,
                        maintainAspectRatio: false, // WAJIB false agar mengisi wrapper
                        plugins: {
                            title: { display: true, text: 'Top 10 Negara (berdasar Pendapatan)' },
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.dataset.label}: ${formatCurrency(context.parsed.x)}`
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { callback: (value) => formatCurrency(value) }
                            }
                        }
                    }
                });
            }

            // 4. Chart Metode Pembayaran (Pie)
            function createPaymentMethodChart() {
                // Mengisi variabel global
                paymentCounts = allTransactions.reduce((acc, tx) => {
                    acc[tx.Payment_Method] = (acc[tx.Payment_Method] || 0) + 1;
                    return acc;
                }, {});

                const labels = Object.keys(paymentCounts);
                const data = Object.values(paymentCounts);

                const ctx = document.getElementById('paymentMethodChart').getContext('2d');
                chartInstances['paymentMethodChart'] = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Jumlah Transaksi',
                            data: data,
                            backgroundColor: [appColors[2], appColors[3], appColors[4], appColors[5], appColors[6], appColors[7]],
                            hoverOffset: 8,
                            borderColor: '#1e293b'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // WAJIB false agar mengisi wrapper
                        plugins: {
                            title: { display: true, text: 'Distribusi Metode Pembayaran' },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(2);
                                        return `${label}: ${formatNumber(value)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // 5. Chart Distribusi Usia (Bar)
            function createAgeDistributionChart() {
                // Mengisi variabel global
                ageBins = {
                    '18-25': 0, '26-35': 0, '36-45': 0,
                    '46-55': 0, '56-65': 0, '65+': 0
                };
                allTransactions.forEach(tx => {
                    if (tx.Age <= 25) ageBins['18-25']++;
                    else if (tx.Age <= 35) ageBins['26-35']++;
                    else if (tx.Age <= 45) ageBins['36-45']++;
                    else if (tx.Age <= 55) ageBins['46-55']++;
                    else if (tx.Age <= 65) ageBins['56-65']++;
                    else ageBins['65+']++;
                });

                const labels = Object.keys(ageBins);
                const data = Object.values(ageBins);

                const ctx = document.getElementById('ageDistributionChart').getContext('2d');
                chartInstances['ageDistributionChart'] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Jumlah Pelanggan',
                            data: data,
                            backgroundColor: appColors[4],
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // WAJIB false agar mengisi wrapper
                        plugins: {
                            title: { display: true, text: 'Distribusi Usia Pelanggan' },
                            legend: { display: false }
                        },
                        scales: {
                            y: { title: { display: true, text: 'Jumlah Pelanggan' } },
                            x: { title: { display: true, text: 'Kelompok Usia' } }
                        }
                    }
                });
            }

            // 6. Chart Distribusi Jumlah Pembelian (Histogram)
            function createPurchaseAmountHistogram() {
                const amounts = allTransactions.map(tx => tx.Purchase_Amount_Num);
                const maxAmount = Math.max(...amounts);
                // Ukuran bin dinamis, maks 20 bin
                const binCount = Math.min(20, Math.ceil(maxAmount / 100));
                const binSize = binCount > 0 ? Math.ceil(maxAmount / binCount) : 100;
                
                const bins = new Array(binCount).fill(0);
                const labels = new Array(binCount).fill(0).map((_, i) => 
                    `$${i * binSize + 1} - $${(i + 1) * binSize}`
                );

                amounts.forEach(amount => {
                    let binIndex = Math.floor(amount / binSize);
                    // Menangani nilai maksimum yang tepat di batas
                    if (amount > 0 && amount % binSize === 0) {
                        binIndex -= 1; 
                    }
                    if (binIndex >= 0 && binIndex < binCount) {
                        bins[binIndex]++;
                    } else if (amount === 0) {
                         // Asumsi 0 masuk ke bin pertama jika ada
                        if (bins.length > 0) bins[0]++;
                    }
                });

                const ctx = document.getElementById('purchaseAmountHistogram').getContext('2d');
                chartInstances['purchaseAmountHistogram'] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Jumlah Transaksi',
                            data: bins,
                            backgroundColor: appColors[5],
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // WAJIB false agar mengisi wrapper
                        plugins: {
                            title: { display: true, text: 'Distribusi Jumlah Pembelian' },
                            legend: { display: false }
                        },
                        scales: {
                            y: { title: { display: true, text: 'Jumlah Transaksi' } },
                            x: { title: { display: true, text: 'Kelompok Jumlah Pembelian' } }
                        }
                    }
                });
            }


            // --- Event Listener ---
            const fileInput = document.getElementById('csvFileInput');
            const fileUploadText = document.getElementById('fileUploadText');

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    fileUploadText.textContent = file.name; // Tampilkan nama file
                    const reader = new FileReader();
                    reader.onload = (e) => processData(e.target.result);
                    reader.onerror = () => {
                        const errorEl = document.getElementById('errorMessage');
                        errorEl.textContent = 'Gagal membaca file.';
                        errorEl.classList.remove('hidden');
                    };
                    reader.readAsText(file);
                } else {
                    fileUploadText.textContent = 'Pilih sebuah file CSV';
                }
            });

        }); // <-- Penutup untuk DOMContentLoaded
    </script>
</body>
</html>
