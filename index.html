<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <!-- Viewport WAJIB untuk responsive design -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Visualisasi Data E-Commerce</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Chart.js (teknologi utama Anda) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Menggunakan font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Mengaplikasikan font Inter ke seluruh halaman */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* bg-slate-900 */
        }
        /* Transisi smooth untuk semua elemen */
        * {
            transition: all 0.15s ease-in-out;
        }
        
        /* --- PERBAIKAN BUG RESPONSIVITAS --- */
        /* Memberi ukuran pada canvas wrapper agar chart tidak 'gepeng' atau 'menghilang' */
        .chart-container {
            position: relative;
            width: 100%;
            /* Rasio 4:3 */
            padding-top: 75%; 
        }
        
        .chart-container-square {
            position: relative;
            width: 100%;
            /* Rasio 1:1 */
            padding-top: 100%; 
            /* Mencegah chart pie/doughnut menjadi terlalu besar di desktop */
            max-height: 500px; 
            margin: 0 auto;
        }

        /* Memaksa canvas mengisi wrapper-nya */
        .chart-container canvas,
        .chart-container-square canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
        }
        
        /* Aturan responsif tambahan untuk Pie/Doughnut */
        .chart-container-square {
             max-width: 90%; /* Sedikit lebih kecil di mobile */
        }
        @media (min-width: 640px) {
             .chart-container-square {
                max-width: 80%; /* Sedang di tablet */
             }
        }
        @media (min-width: 1024px) {
             .chart-container-square {
                max-width: 100%; /* Ukuran penuh di grid desktop */
             }
        }

        /* [BARU] Style untuk daftar rincian data */
        .detail-list {
            list-style: none;
            padding-left: 0;
            max-height: 160px; /* Batasi tinggi, tambahkan scroll */
            overflow-y: auto;
            font-size: 0.875rem; /* text-sm */
            margin-top: 0;
            padding-right: 10px; /* Ruang untuk scrollbar */
        }
        .detail-list::-webkit-scrollbar {
            width: 6px;
        }
        .detail-list::-webkit-scrollbar-thumb {
            background: #475569; /* bg-slate-600 */
            border-radius: 3px;
        }
        .detail-list::-webkit-scrollbar-track {
            background: #334155; /* bg-slate-700 */
        }
        .detail-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 4px;
            border-bottom: 1px solid #334155; /* border-slate-700 */
        }
        .detail-list li:last-child {
            border-bottom: none;
        }
        .detail-list .label {
            color: #cbd5e1; /* text-slate-300 */
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 10px;
        }
        .detail-list .value-group {
            text-align: right;
            flex-shrink: 0; /* Mencegah grup ini mengecil */
        }
        .detail-list .value {
            color: #ffffff; /* text-white */
            font-weight: 600;
            display: block;
            font-size: 0.9rem;
        }
        .detail-list .percent {
            color: #94a3b8; /* text-slate-400 */
            font-size: 0.8rem; /* text-xs */
            display: block;
        }
    </style>
</head>
<body class="bg-slate-900 text-gray-200 min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header Utama -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">
                Dashboard Visualisasi Data E-Commerce
            </h1>
            <p class="text-lg text-gray-400 mb-3">
                Analisis interaktif dari data transaksi e-commerce.
            </p>
            <p class="text-sm text-gray-500">
                Dikerjakan oleh: Andrian, Joice Omasi Angelita Harefa, Fauzan Al Gholi dan Al At Tejana
            </p>
        </header>

        <!-- Panel Kontrol: Upload File -->
        <div class="bg-slate-800 p-6 rounded-lg shadow-xl mb-8 max-w-2xl mx-auto">
            <h2 class="text-xl font-semibold mb-4 text-white text-center">Mulai Analisis</h2>
            <p class="text-gray-400 mb-5 text-center text-sm">
                Unggah file `ecommerce_transactions.csv` Anda untuk memuat dashboard.
            </p>
            
            <label for="csvFileInput" class="w-full flex justify-center px-4 py-6 bg-slate-700 rounded-lg border-2 border-dashed border-slate-600 cursor-pointer hover:border-blue-500 hover:bg-slate-700/80">
                <div class="text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-500" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                    <span class="mt-2 block text-sm font-semibold text-blue-400" id="fileUploadText">Pilih sebuah file CSV</span>
                    <span class="block text-xs text-gray-500">Atau seret dan lepas di sini</span>
                </div>
                <input type="file" id="csvFileInput" accept=".csv" class="hidden">
            </label>

            <!-- Indikator Loading dan Pesan Error -->
            <div id="loadingMessage" class="hidden mt-4 text-blue-400 flex items-center justify-center">
                <svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Memproses data...
            </div>
            <div id="errorMessage" class="hidden mt-4 text-red-400 font-medium text-center"></div>
        </div>

        <!-- Kontainer Statistik Utama -->
        <div id="statsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 hidden">
            <!-- Stat 1: Total Transaksi -->
            <div class="bg-slate-800 p-5 rounded-lg shadow-lg flex items-center space-x-4">
                <div class="flex-shrink-0 bg-blue-600 p-3 rounded-full">
                    <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H7a3 3 0 00-3 3v8a3 3 0 003 3z" />
                    </svg>
                </div>
                <div>
                    <h3 class="text-gray-400 text-sm font-medium">Total Transaksi</h3>
                    <p id="totalTransactions" class="text-2xl font-bold text-white">0</p>
                </div>
            </div>
            <!-- Stat 2: Total Pendapatan -->
            <div class="bg-slate-800 p-5 rounded-lg shadow-lg flex items-center space-x-4">
                <div class="flex-shrink-0 bg-emerald-600 p-3 rounded-full">
                     <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0c-1.657 0-3-.895-3-2s1.343-2 3-2 3-.895 3-2-1.343-2-3-2m9 4a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div>
                    <h3 class="text-gray-400 text-sm font-medium">Total Pendapatan</h3>
                    <p id="totalRevenue" class="text-2xl font-bold text-white">0</p>
                </div>
            </div>
            <!-- Stat 3: Pembelian Rata-rata -->
            <div class="bg-slate-800 p-5 rounded-lg shadow-lg flex items-center space-x-4">
                <div class="flex-shrink-0 bg-amber-600 p-3 rounded-full">
                    <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                </div>
                <div>
                    <h3 class="text-gray-400 text-sm font-medium">Pembelian Rata-rata</h3>
                    <p id="averagePurchase" class="text-2xl font-bold text-white">0</p>
                </div>
            </div>
            <!-- Stat 4: Negara Teratas -->
            <div class="bg-slate-800 p-5 rounded-lg shadow-lg flex items-center space-x-4">
                <div class="flex-shrink-0 bg-purple-600 p-3 rounded-full">
                    <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c-1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03 3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                    </svg>
                </div>
                <div>
                    <h3 class="text-gray-400 text-sm font-medium">Negara Teratas</h3>
                    <p id="topCountry" class="text-2xl font-bold text-white">-</p>
                </div>
            </div>
        </div>

        <!-- Grid untuk Chart (Responsif) -->
        <div id="chartsGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-6 hidden">
            
            <!-- Chart 1: Tren Penjualan per Bulan (Line Chart) -->
            <div class="bg-slate-800 p-4 md:p-6 rounded-lg shadow-lg">
                <div class="chart-container">
                    <canvas id="salesOverTimeChart"></canvas>
                </div>
                <!-- [DIPERBARUI] Kotak interpretasi dengan ID untuk data dinamis -->
                <div class="mt-4 p-4 bg-slate-700 rounded-lg">
                    <h4 class="text-white font-semibold mb-2">Rincian Tren Penjualan</h4>
                    <!-- [DIPERBARUI] Konten akan diisi oleh JS dengan daftar lengkap -->
                    <div class="text-sm text-gray-300" id="salesOverTimeInterpretation">
                        Muat data untuk melihat interpretasi...
                    </div>
                </div>
            </div>

            <!-- Chart 2: Penjualan per Kategori Produk (Doughnut Chart) -->
            <div class="bg-slate-800 p-4 md:p-6 rounded-lg shadow-lg">
                <div class="chart-container-square">
                    <canvas id="categoryChart"></canvas>
                </div>
                <!-- [DIPERBARUI] Kotak interpretasi dengan ID untuk data dinamis -->
                <div class="mt-4 p-4 bg-slate-700 rounded-lg">
                    <h4 class="text-white font-semibold mb-2">Rincian Kategori Produk</h4>
                    <!-- [DIPERBARUI] Konten akan diisi oleh JS dengan daftar lengkap -->
                    <div class="text-sm text-gray-300" id="categoryInterpretation">
                        Muat data untuk melihat interpretasi...
                    </div>
                </div>
            </div>

            <!-- Chart 3: Top 10 Negara (Bar Chart) -->
            <div class="bg-slate-800 p-4 md:p-6 rounded-lg shadow-lg">
                <div class="chart-container">
                    <canvas id="countryChart"></canvas>
                </div>
                <!-- [DIPERBARUI] Kotak interpretasi dengan ID untuk data dinamis -->
                <div class="mt-4 p-4 bg-slate-700 rounded-lg">
                    <h4 class="text-white font-semibold mb-2">Rincian Pasar Geografis</h4>
                    <!-- [DIPERBARUI] Konten akan diisi oleh JS dengan daftar lengkap -->
                    <div class="text-sm text-gray-300" id="countryInterpretation">
                        Muat data untuk melihat interpretasi...
                    </div>
                </div>
            </div>

            <!-- Chart 4: Distribusi Metode Pembayaran (Pie Chart) -->
            <div class="bg-slate-800 p-4 md:p-6 rounded-lg shadow-lg">
                <div class="chart-container-square">
                    <canvas id="paymentMethodChart"></canvas>
                </div>
                <!-- [DIPERBARUI] Kotak interpretasi dengan ID untuk data dinamis -->
                <div class="mt-4 p-4 bg-slate-700 rounded-lg">
                    <h4 class="text-white font-semibold mb-2">Rincian Metode Pembayaran</h4>
                    <!-- [DIPERBARUI] Konten akan diisi oleh JS dengan daftar lengkap -->
                    <div class="text-sm text-gray-300" id="paymentMethodInterpretation">
                        Muat data untuk melihat interpretasi...
                    </div>
                </div>
            </div>

            <!-- Chart 5: Distribusi Usia Pelanggan (Bar Chart) -->
            <div class="bg-slate-800 p-4 md:p-6 rounded-lg shadow-lg">
                <div class="chart-container">
                    <canvas id="ageDistributionChart"></canvas>
                </div>
                <!-- [DIPERBARUI] Kotak interpretasi dengan ID untuk data dinamis -->
                <div class="mt-4 p-4 bg-slate-700 rounded-lg">
                    <h4 class="text-white font-semibold mb-2">Rincian Demografi Pelanggan</h4>
                    <!-- [DIPERBARUI] Konten akan diisi oleh JS dengan daftar lengkap -->
                    <div class="text-sm text-gray-300" id="ageDistributionInterpretation">
                        Muat data untuk melihat interpretasi...
                    </div>
                </div>
            </div>

            <!-- Chart 6: Distribusi Jumlah Pembelian (Histogram) -->
            <div class="bg-slate-800 p-4 md:p-6 rounded-lg shadow-lg">
                <div class="chart-container">
                    <canvas id="purchaseAmountHistogram"></canvas>
                </div>
                <!-- [DIPERBARUI] Kotak interpretasi dengan ID untuk data dinamis -->
                <div class="mt-4 p-4 bg-slate-700 rounded-lg">
                    <h4 class="text-white font-semibold mb-2">Rincian Nilai Transaksi</h4>
                    <!-- [DIPERBARUI] Konten akan diisi oleh JS dengan daftar lengkap -->
                    <div class="text-sm text-gray-300" id="purchaseAmountHistogramInterpretation">
                        Muat data untuk melihat interpretasi...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bagian Interpretasi & Kesimpulan Dinamis -->
        <div id="interpretationSection" class="bg-slate-800 p-6 md:p-8 rounded-lg shadow-lg hidden mt-8">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Analisis & Kesimpulan Utama</h2>
            <div id="interpretationContent" class="space-y-4 text-gray-300">
                <p class="text-center text-gray-500">Memuat data interpretasi...</p>
            </div>
        </div>

        <!-- Footer Sederhana -->
        <footer class="mt-12 text-center text-sm text-gray-600">
            <p>Tugas Mata Kuliah Big Data &copy; 2025</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Konfigurasi Global Chart.js (Ditingkatkan) ---
            Chart.defaults.color = '#cbd5e1'; // text-slate-300
            Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)'; // Garis grid tipis
            Chart.defaults.animation = {
                duration: 1000,
                easing: 'easeOutQuart'
            };
            Chart.defaults.plugins.title.color = '#ffffff'; // text-white
            Chart.defaults.plugins.title.font = {
                size: 18,
                weight: '600',
                family: "'Inter', sans-serif"
            };
            Chart.defaults.plugins.legend.labels.color = '#cbd5e1';
            
            // Konfigurasi Tooltip Kustom (saat hover)
            Chart.defaults.plugins.tooltip.enabled = true;
            Chart.defaults.plugins.tooltip.backgroundColor = '#1e293b'; // bg-slate-800
            Chart.defaults.plugins.tooltip.titleColor = '#ffffff';
            Chart.defaults.plugins.tooltip.bodyColor = '#cbd5e1';
            Chart.defaults.plugins.tooltip.borderColor = 'rgba(255, 255, 255, 0.1)';
            Chart.defaults.plugins.tooltip.borderWidth = 1;
            Chart.defaults.plugins.tooltip.padding = 10;
            Chart.defaults.plugins.tooltip.cornerRadius = 6;
            Chart.defaults.plugins.tooltip.boxPadding = 3;
            Chart.defaults.plugins.tooltip.titleFont = { size: 14, weight: '600' };
            Chart.defaults.plugins.tooltip.bodyFont = { size: 12 };
            // --- Akhir Konfigurasi Global ---

            let allTransactions = []; 
            const chartInstances = {}; 
            
            // Variabel untuk menyimpan data agregat
            let categorySales = {};
            let countrySales = {};
            let paymentCounts = {};
            let ageBins = {};
            // [BARU] Variabel global untuk data agregat baru
            let salesByMonthData = {};
            // [BARU] Variabel global untuk data histogram
            let histogramData = { labels: [], bins: [] };

            // Palet warna kustom untuk chart
            const appColors = [
                '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                '#14b8a6', '#f97316', '#d946ef', '#0ea5e9', '#65a30d'
            ];
            
            // --- Helper Functions ---
            function destroyChart(chartId) {
                if (chartInstances[chartId]) {
                    chartInstances[chartId].destroy();
                    delete chartInstances[chartId];
                }
            }
            function formatCurrency(amount) {
                // Perbaikan: Menangani nilai non-numerik dengan aman
                if (typeof amount !== 'number' || isNaN(amount)) {
                    amount = 0;
                }
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
            }
            function formatNumber(num) {
                if (typeof num !== 'number' || isNaN(num)) {
                    num = 0;
                }
                return new Intl.NumberFormat('id-ID').format(num);
            }
            function parseCSV(text, delimiter) {
                const lines = text.split(/\r\n|\n/);
                const headers = lines[0].split(delimiter).map(h => h.trim());
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === "") continue; 
                    const values = lines[i].split(delimiter);
                    if (values.length === headers.length) {
                        const entry = {};
                        for (let j = 0; j < headers.length; j++) {
                            entry[headers[j]] = values[j].trim();
                        }
                        data.push(entry);
                    }
                }
                return data;
            }
            function getTopEntry(obj) {
                if (Object.keys(obj).length === 0) return ['-', 0];
                return Object.entries(obj).sort(([, a], [, b]) => b - a)[0];
            }

            // --- Fungsi Processing Data Utama ---
            function processData(csvText) {
                document.getElementById('loadingMessage').classList.remove('hidden');
                document.getElementById('errorMessage').classList.add('hidden');

                try {
                    // --- Logika Deteksi Cerdas ---
                    const firstLine = csvText.split(/\r\n|\n/)[0];
                    // 1. Deteksi Delimiter (Pemisah)
                    const commaCount = (firstLine.match(/,/g) || []).length;
                    const semicolonCount = (firstLine.match(/;/g) || []).length;
                    const delimiter = semicolonCount > commaCount ? ';' : ',';
                    
                    const parsedData = parseCSV(csvText, delimiter);
                    if (parsedData.length === 0) throw new Error("Tidak ada data yang bisa diparsing.");

                    const sampleRow = parsedData[0];
                    if (!sampleRow.Purchase_Amount || !sampleRow.Transaction_Date) {
                        throw new Error("Header CSV tidak ditemukan. Pastikan ada kolom 'Purchase_Amount' dan 'Transaction_Date'.");
                    }
                    
                    const sampleAmount = sampleRow.Purchase_Amount;
                    const sampleDate = sampleRow.Transaction_Date;

                    // 2. Deteksi Format Angka (US/UK vs Eropa)
                    let numberParser;
                    if (sampleAmount.includes(',') && sampleAmount.lastIndexOf(',') > sampleAmount.lastIndexOf('.')) {
                        // Format Eropa: "1.234,56"
                        numberParser = (str) => parseFloat(str.replace(/\./g, '').replace(',', '.'));
                    } else {
                        // Format US/UK: "1,234.56"
                        numberParser = (str) => parseFloat(str.replace(/,/g, ''));
                    }

                    // 3. Deteksi Format Tanggal (DD/MM/YYYY vs MM/DD/YYYY)
                    let dateParser;
                    const dateParts = sampleDate.split('/');
                    if (dateParts.length !== 3) throw new Error("Format tanggal tidak dikenal. Harap gunakan pemisah '/'.");

                    if (parseInt(dateParts[0]) > 12) {
                        // Bagian pertama > 12, pasti DD/MM/YYYY
                        dateParser = (str) => { const p = str.split('/'); return new Date(+p[2], p[1] - 1, +p[0]); };
                    } else if (parseInt(dateParts[1]) > 12) {
                        // Bagian kedua > 12, pasti MM/DD/YYYY
                        dateParser = (str) => { const p = str.split('/'); return new Date(+p[2], p[0] - 1, +p[1]); };
                    } else {
                        // Tidak bisa dideteksi (misal: 01/02/2023), asumsi DD/MM/YYYY
                        dateParser = (str) => { const p = str.split('/'); return new Date(+p[2], p[1] - 1, +p[0]); };
                    }
                    // --- Akhir Logika Deteksi ---

                    allTransactions = parsedData.map(row => ({
                        ...row,
                        Age: parseInt(row.Age) || 0,
                        Purchase_Amount_Num: numberParser(row.Purchase_Amount) || 0,
                        Transaction_Date_Obj: dateParser(row.Transaction_Date),
                    })).filter(row => 
                        // Filter data yang tidak valid
                        row.Transaction_ID && 
                        row.Transaction_Date_Obj instanceof Date && 
                        !isNaN(row.Transaction_Date_Obj) &&
                        !isNaN(row.Purchase_Amount_Num)
                    ); 

                    if (allTransactions.length === 0) throw new Error("Tidak ada data valid yang ditemukan setelah parsing.");

                    // Hancurkan chart lama & reset data
                    Object.keys(chartInstances).forEach(id => destroyChart(id));
                    categorySales = {}; countrySales = {}; paymentCounts = {}; ageBins = {}; salesByMonthData = {}; histogramData = { labels: [], bins: [] };
                    
                    // [BARU] Reset semua teks interpretasi dinamis
                    const interpretationElements = [
                        'salesOverTimeInterpretation', 'categoryInterpretation', 'countryInterpretation',
                        'paymentMethodInterpretation', 'ageDistributionInterpretation', 'purchaseAmountHistogramInterpretation'
                    ];
                    interpretationElements.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.innerHTML = 'Memuat data interpretasi...';
                    });

                    // Tampilkan stats & render chart baru
                    displayStats();
                    createSalesOverTimeChart();
                    createCategoryChart();
                    createCountryChart();
                    createPaymentMethodChart();
                    createAgeDistributionChart();
                    createPurchaseAmountHistogram();
                    displayInterpretations(); // Ini untuk kesimpulan utama

                    // Tampilkan UI
                    document.getElementById('statsContainer').classList.remove('hidden');
                    document.getElementById('chartsGrid').classList.remove('hidden');
                    document.getElementById('interpretationSection').classList.remove('hidden');
                    
                } catch (error) {
                    console.error("Error processing data:", error);
                    const errorEl = document.getElementById('errorMessage');
                    errorEl.textContent = `Error: ${error.message}`;
                    errorEl.classList.remove('hidden');
                } finally {
                    document.getElementById('loadingMessage').classList.add('hidden');
                }
            }
            
            // --- Fungsi Statistik & Interpretasi ---
            function displayStats() {
                const totalTransactions = allTransactions.length;
                const totalRevenue = allTransactions.reduce((sum, tx) => sum + tx.Purchase_Amount_Num, 0);
                const averagePurchase = totalRevenue / totalTransactions;
                
                // Hitung countrySales di sini agar bisa diakses oleh displayInterpretations
                countrySales = allTransactions.reduce((acc, tx) => { acc[tx.Country] = (acc[tx.Country] || 0) + tx.Purchase_Amount_Num; return acc; }, {});
                const [topCountry] = getTopEntry(countrySales);

                document.getElementById('totalTransactions').textContent = formatNumber(totalTransactions);
                document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
                document.getElementById('averagePurchase').textContent = formatCurrency(averagePurchase);
                document.getElementById('topCountry').textContent = topCountry;
            }
            
            // Fungsi ini sekarang HANYA untuk KESIMPULAN UTAMA
            function displayInterpretations() {
                const interpretationContent = document.getElementById('interpretationContent');
                if (!interpretationContent) return;
                
                try {
                    const [topCategory, topCategorySales] = getTopEntry(categorySales);
                    const totalRevenue = Object.values(categorySales).reduce((a, b) => a + b, 0);
                    const topCategoryPercent = totalRevenue > 0 ? ((topCategorySales / totalRevenue) * 100).toFixed(1) : 0;
                    
                    const [topCountry] = getTopEntry(countrySales);
                    
                    const [topPayment, topPaymentCount] = getTopEntry(paymentCounts);
                    const totalTx = Object.values(paymentCounts).reduce((a, b) => a + b, 0);
                    const topPaymentPercent = totalTx > 0 ? ((topPaymentCount / totalTx) * 100).toFixed(1) : 0;
                    
                    const [topAgeGroup] = getTopEntry(ageBins);

                    const conclusion = `Data menunjukkan fokus bisnis yang kuat pada kategori <strong>${topCategory}</strong>, yang menyumbang ${topCategoryPercent}% pendapatan. Pasar utama adalah <strong>${topCountry}</strong>, dengan demografi inti pada kelompok usia <strong>${topAgeGroup}</strong>.`;

                    interpretationContent.innerHTML = `
                        <h3 class="text-xl font-semibold text-white mb-3">Interpretasi Data</h3>
                        <ul class="list-disc list-inside space-y-2 text-gray-300">
                            <li><strong>Kategori Produk Dominan:</strong> Kategori <strong>${topCategory}</strong> adalah pendorong pendapatan terbesar, menghasilkan <strong>${formatCurrency(topCategorySales)}</strong> (sekitar <strong>${topCategoryPercent}%</strong> dari total).</li>
                            <li><strong>Pasar Geografis Inti:</strong> Data mengkonfirmasi bahwa <strong>${topCountry}</strong> adalah pasar terkuat.</li>
                            <li><strong>Demografi Pelanggan Utama:</strong> Kelompok usia <strong>${topAgeGroup}</strong> tahun adalah segmen pelanggan yang paling aktif.</li>
                            <li><strong>Preferensi Pembayaran:</strong> Metode pembayaran yang paling sering digunakan adalah <strong>${topPayment}</strong>, mencakup <strong>${topPaymentPercent}%</strong> dari seluruh transaksi.</li>
                        </ul>
                        <h3 class="text-xl font-semibold text-white mt-6 mb-3">Kesimpulan & Rekomendasi</h3>
                        <p class="text-gray-400 leading-relaxed">${conclusion} Rekomendasi: (1) diversifikasi produk di luar ${topCategory}, (2) optimalkan marketing untuk usia ${topAgeGroup} di ${topCountry}, dan (3) evaluasi promosi untuk metode pembayaran selain ${topPayment}.</p>
                    `;
                } catch (e) {
                    interpretationContent.innerHTML = `<p class="text-red-400">Gagal menghasilkan interpretasi: ${e.message}</p>`;
                    console.error("Error generating interpretation:", e);
                }
            }

            // --- Fungsi Pembuatan Chart ---

            // 1. Chart Tren Penjualan per Bulan (Line)
            function createSalesOverTimeChart() {
                // Data agregat dihitung dan disimpan secara global
                salesByMonthData = allTransactions.reduce((acc, tx) => {
                    const monthKey = `${tx.Transaction_Date_Obj.getFullYear()}-${(tx.Transaction_Date_Obj.getMonth() + 1).toString().padStart(2, '0')}`;
                    acc[monthKey] = (acc[monthKey] || 0) + tx.Purchase_Amount_Num;
                    return acc;
                }, {});

                const sortedMonths = Object.keys(salesByMonthData).sort();
                const labels = sortedMonths;
                const data = sortedMonths.map(month => salesByMonthData[month]);
                
                const ctx = document.getElementById('salesOverTimeChart').getContext('2d');
                
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(59, 130, 246, 0.4)');
                gradient.addColorStop(1, 'rgba(59, 130, 246, 0.05)');

                const chartId = 'salesOverTimeChart';

                chartInstances[chartId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Penjualan',
                            data: data,
                            borderColor: appColors[0], 
                            backgroundColor: gradient, 
                            borderWidth: 2.5,
                            fill: true,
                            tension: 0.4, 
                            pointRadius: 0, 
                            pointHitRadius: 10, 
                            pointHoverRadius: 6, 
                            pointHoverBackgroundColor: appColors[0],
                            pointHoverBorderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, 
                        plugins: {
                            title: { display: true, text: 'Tren Penjualan (per Bulan)' },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: (context) => `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`
                                }
                            }
                        },
                        scales: {
                            y: {
                                grid: { color: 'rgba(255, 255, 255, 0.05)' } 
                            },
                            x: {
                                grid: { display: false } 
                            }
                        }
                    }
                });

                // [DIPERBARUI] Menambahkan rincian data lengkap
                try {
                    const sortedData = labels.map((label, index) => ({
                        label: label,
                        value: data[index]
                    })).sort((a, b) => b.value - a.value); // Urutkan berdasarkan nilai
                    
                    const totalSales = data.reduce((a, b) => a + b, 0);
                    
                    let htmlList = '<ul class="detail-list">';
                    sortedData.forEach(({ label, value }) => {
                        const percent = ((value / totalSales) * 100).toFixed(1);
                        htmlList += `
                            <li>
                                <span class="label">${label}</span>
                                <div class="value-group">
                                    <span class="value">${formatCurrency(value)}</span>
                                    <span class="percent">(${percent}%)</span>
                                </div>
                            </li>
                        `;
                    });
                    htmlList += '</ul>';

                    document.getElementById('salesOverTimeInterpretation').innerHTML = htmlList;
                } catch (e) {
                    document.getElementById('salesOverTimeInterpretation').innerHTML = "Gagal memuat rincian data tren.";
                }
            }

            // 2. Chart Penjualan per Kategori (Doughnut)
            function createCategoryChart() {
                // Data agregat disimpan secara global
                categorySales = allTransactions.reduce((acc, tx) => {
                    acc[tx.Product_Category] = (acc[tx.Product_Category] || 0) + tx.Purchase_Amount_Num;
                    return acc;
                }, {});

                const labels = Object.keys(categorySales);
                const data = Object.values(categorySales);
                const ctx = document.getElementById('categoryChart').getContext('2d');
                
                const chartId = 'categoryChart';

                chartInstances[chartId] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Penjualan',
                            data: data,
                            backgroundColor: appColors,
                            hoverOffset: 12, 
                            borderColor: '#1e293b', 
                            borderWidth: 3, 
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true, 
                        cutout: '65%', 
                        plugins: {
                            title: { display: true, text: 'Penjualan per Kategori Produk' },
                            legend: {
                                position: 'right', 
                                labels: { boxWidth: 12, padding: 15 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(2);
                                        return `${context.label}: ${formatCurrency(context.parsed)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // [DIPERBARUI] Menambahkan rincian data lengkap
                try {
                    const sortedCategories = Object.entries(categorySales).sort(([, a], [, b]) => b - a);
                    const totalSales = sortedCategories.reduce((acc, [, sales]) => acc + sales, 0);
                    
                    let htmlList = '<ul class="detail-list">';
                    sortedCategories.forEach(([category, sales]) => {
                        const percent = ((sales / totalSales) * 100).toFixed(1);
                        htmlList += `
                            <li>
                                <span class="label">${category}</span>
                                <div class="value-group">
                                    <span class="value">${formatCurrency(sales)}</span>
                                    <span class="percent">(${percent}%)</span>
                                </div>
                            </li>
                        `;
                    });
                    htmlList += '</ul>';

                    document.getElementById('categoryInterpretation').innerHTML = htmlList;
                } catch (e) {
                    document.getElementById('categoryInterpretation').innerHTML = "Gagal memuat rincian data kategori.";
                }
            }

            // 3. Chart Top 10 Negara (Bar)
            function createCountryChart() {
                // countrySales sudah dihitung di displayStats()
                const sortedCountries = Object.entries(countrySales).sort(([, a], [, b]) => b - a).slice(0, 10);
                const labels = sortedCountries.map(entry => entry[0]);
                const data = sortedCountries.map(entry => entry[1]);
                
                const ctx = document.getElementById('countryChart').getContext('2d');

                const gradient = ctx.createLinearGradient(0, 0, 500, 0); 
                gradient.addColorStop(0, 'rgba(22, 163, 74, 0.6)'); 
                gradient.addColorStop(1, 'rgba(22, 163, 74, 1)');

                const chartId = 'countryChart';

                chartInstances[chartId] = new Chart(ctx, {
                    type: 'bar', 
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Pendapatan',
                            data: data,
                            backgroundColor: gradient,
                            hoverBackgroundColor: appColors[1],
                            borderRadius: 6, 
                            borderWidth: 0,
                        }]
                    },
                    options: {
                        indexAxis: 'y', 
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: 'Top 10 Negara (berdasar Pendapatan)' },
                            legend: { display: false }, 
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.dataset.label}: ${formatCurrency(context.parsed.x)}`
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false } 
                            },
                            y: {
                                grid: { display: false }
                            }
                        }
                    }
                });

                // [DIPERBARUI] Menambahkan rincian data lengkap
                try {
                    // sortedCountries sudah top 10 dan terurut
                    const totalTop10Sales = sortedCountries.reduce((acc, [, sales]) => acc + sales, 0);
                    
                    let htmlList = '<ul class="detail-list">';
                    sortedCountries.forEach(([country, sales]) => {
                        // Persentase dihitung berdasarkan total dari 10 negara teratas
                        const percent = ((sales / totalTop10Sales) * 100).toFixed(1);
                        htmlList += `
                            <li>
                                <span class="label">${country}</span>
                                <div class="value-group">
                                    <span class="value">${formatCurrency(sales)}</span>
                                    <span class="percent">(${percent}%)</span>
                                </div>
                            </li>
                        `;
                    });
                    htmlList += '</ul>';

                    document.getElementById('countryInterpretation').innerHTML = htmlList;
                } catch (e) {
                    document.getElementById('countryInterpretation').innerHTML = "Gagal memuat rincian data negara.";
                }
            }

            // 4. Chart Distribusi Metode Pembayaran (Pie)
            function createPaymentMethodChart() {
                // Data agregat disimpan secara global
                paymentCounts = allTransactions.reduce((acc, tx) => {
                    acc[tx.Payment_Method] = (acc[tx.Payment_Method] || 0) + 1; 
                    return acc;
                }, {});

                const labels = Object.keys(paymentCounts);
                const data = Object.values(paymentCounts);
                const ctx = document.getElementById('paymentMethodChart').getContext('2d');
                
                const chartId = 'paymentMethodChart';
                
                chartInstances[chartId] = new Chart(ctx, {
                    type: 'pie', 
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Jumlah Transaksi',
                            data: data,
                            backgroundColor: [appColors[2], appColors[3], appColors[4], appColors[5], appColors[6], appColors[7]], 
                            hoverOffset: 12,
                            borderColor: '#1e293b',
                            borderWidth: 3,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true, 
                        plugins: {
                            title: { display: true, text: 'Distribusi Metode Pembayaran' },
                            legend: {
                                position: 'top', 
                                labels: { boxWidth: 12, padding: 15 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(2);
                                        return `${context.label}: ${formatNumber(context.parsed)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // [DIPERBARUI] Menambahkan rincian data lengkap
                try {
                    const sortedPayments = Object.entries(paymentCounts).sort(([, a], [, b]) => b - a);
                    const totalTx = sortedPayments.reduce((acc, [, count]) => acc + count, 0);

                    let htmlList = '<ul class="detail-list">';
                    sortedPayments.forEach(([method, count]) => {
                        const percent = ((count / totalTx) * 100).toFixed(1);
                        htmlList += `
                            <li>
                                <span class="label">${method}</span>
                                <div class="value-group">
                                    <span class="value">${formatNumber(count)}</span>
                                    <span class="percent">(${percent}%)</span>
                                </div>
                            </li>
                        `;
                    });
                    htmlList += '</ul>';

                    document.getElementById('paymentMethodInterpretation').innerHTML = htmlList;
                } catch (e) {
                    document.getElementById('paymentMethodInterpretation').innerHTML = "Gagal memuat rincian data pembayaran.";
                }
            }

            // 5. Chart Distribusi Usia Pelanggan (Bar)
            function createAgeDistributionChart() {
                // Data agregat disimpan secara global
                ageBins = { '18-25': 0, '26-35': 0, '36-45': 0, '46-55': 0, '56-65': 0, '65+': 0 };
                allTransactions.forEach(tx => {
                    if (tx.Age <= 25) ageBins['18-25']++;
                    else if (tx.Age <= 35) ageBins['26-35']++;
                    else if (tx.Age <= 45) ageBins['36-45']++;
                    else if (tx.Age <= 55) ageBins['46-55']++;
                    else if (tx.Age <= 65) ageBins['56-65']++;
                    else ageBins['65+']++;
                });

                const labels = Object.keys(ageBins);
                const data = Object.values(ageBins);
                const ctx = document.getElementById('ageDistributionChart').getContext('2d');
                
                const chartId = 'ageDistributionChart';

                chartInstances[chartId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Jumlah Pelanggan',
                            data: data,
                            backgroundColor: appColors[4], 
                            hoverBackgroundColor: 'rgba(139, 92, 246, 0.8)',
                            borderRadius: 6, 
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: 'Distribusi Usia Pelanggan' },
                            legend: { display: false }
                        },
                        scales: {
                            y: { 
                                title: { display: true, text: 'Jumlah Pelanggan' },
                                grid: { color: 'rgba(255, 255, 255, 0.05)' }
                            },
                            x: { 
                                title: { display: true, text: 'Kelompok Usia' },
                                grid: { display: false }
                            }
                        }
                    }
                });

                // [DIPERBARUI] Menambahkan rincian data lengkap
                try {
                    const sortedAges = Object.entries(ageBins).sort(([, a], [, b]) => b - a);
                    const totalUsers = sortedAges.reduce((acc, [, count]) => acc + count, 0);
                    
                    let htmlList = '<ul class="detail-list">';
                    sortedAges.forEach(([group, count]) => {
                        const percent = ((count / totalUsers) * 100).toFixed(1);
                        htmlList += `
                            <li>
                                <span class="label">${group} tahun</span>
                                <div class="value-group">
                                    <span class="value">${formatNumber(count)}</span>
                                    <span class="percent">(${percent}%)</span>
                                </div>
                            </li>
                        `;
                    });
                    htmlList += '</ul>';

                    document.getElementById('ageDistributionInterpretation').innerHTML = htmlList;
                } catch(e) {
                    document.getElementById('ageDistributionInterpretation').innerHTML = "Gagal memuat rincian data usia.";
                }
            }

            // 6. Chart Distribusi Jumlah Pembelian (Histogram)
            function createPurchaseAmountHistogram() {
                const amounts = allTransactions.map(tx => tx.Purchase_Amount_Num);
                const maxAmount = Math.max(...amounts);
                const binCount = Math.min(20, Math.ceil(maxAmount / 100)); 
                const binSize = binCount > 0 ? Math.ceil(maxAmount / binCount) : 100;

                const bins = new Array(binCount).fill(0);
                const labels = new Array(binCount).fill(0).map((_, i) => `$${i * binSize + 1} - $${(i + 1) * binSize}`);

                amounts.forEach(amount => {
                    let binIndex = Math.floor(amount / binSize);
                    if (amount > 0 && amount % binSize === 0) binIndex -= 1; 
                    
                    if (binIndex >= 0 && binIndex < binCount) {
                        bins[binIndex]++;
                    } else if (amount === 0 && bins.length > 0) {
                        bins[0]++; 
                    }
                });

                // Simpan ke variabel global
                histogramData = { labels, bins };
                
                const ctx = document.getElementById('purchaseAmountHistogram').getContext('2d');

                const chartId = 'purchaseAmountHistogram';

                chartInstances[chartId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Jumlah Transaksi',
                            data: bins,
                            backgroundColor: appColors[5], 
                            hoverBackgroundColor: 'rgba(20, 184, 166, 0.8)',
                            borderRadius: 6,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: 'Distribusi Jumlah Pembelian' },
                            legend: { display: false }
                        },
                        scales: {
                            y: { 
                                title: { display: true, text: 'Jumlah Transaksi' },
                                grid: { color: 'rgba(255, 255, 255, 0.05)' } 
                            },
                            x: { 
                                title: { display: true, text: 'Kelompok Jumlah Pembelian' },
                                grid: { display: false } 
                            }
                        }
                    }
                });

                 // [DIPERBARUI] Menambahkan rincian data lengkap
                try {
                    const sortedData = labels.map((label, index) => ({
                        label: label,
                        count: bins[index]
                    })).sort((a, b) => b.count - a.count); // Urutkan berdasarkan jumlah
                    
                    const totalTx = bins.reduce((a, b) => a + b, 0);

                    let htmlList = '<ul class="detail-list">';
                    sortedData.forEach(({ label, count }) => {
                        const percent = ((count / totalTx) * 100).toFixed(1);
                        htmlList += `
                            <li>
                                <span class="label">${label}</span>
                                <div class="value-group">
                                    <span class="value">${formatNumber(count)}</span>
                                    <span class="percent">(${percent}%)</span>
                                </div>
                            </li>
                        `;
                    });
                    htmlList += '</ul>';
                    
                    document.getElementById('purchaseAmountHistogramInterpretation').innerHTML = htmlList;
                } catch(e) {
                     document.getElementById('purchaseAmountHistogramInterpretation').innerHTML = "Gagal memuat rincian nilai transaksi.";
                }
            }

            // --- Event Listener untuk Upload File ---
            const fileInput = document.getElementById('csvFileInput');
            const fileUploadText = document.getElementById('fileUploadText');

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    fileUploadText.textContent = file.name; // Tampilkan nama file
                    const reader = new FileReader();
                    reader.onload = (e) => processData(e.target.result);
                    reader.onerror = () => {
                        const errorEl = document.getElementById('errorMessage');
                        errorEl.textContent = 'Gagal membaca file.';
                        errorEl.classList.remove('hidden');
                    };
                    reader.readAsText(file);
                } else {
                    fileUploadText.textContent = 'Pilih sebuah file CSV';
                }
            });

        }); // <-- Penutup untuk DOMContentLoaded
    </script>
</body>
</html>

